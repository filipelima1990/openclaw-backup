# 2026-02-18 - OddsPortal Loop Bug Investigation

## Incident Summary
**Time:** 13:48-13:50 UTC (Wed Feb 18, 2026)
**Issue:** OddsPortal predictions repeated 5 times in webchat session without user interaction
**Root Cause:** Message routing bug in OpenClaw delivery system

## Timeline of Events

### Morning Cron Runs
1. **10:00 AM UTC** - Cron job started, timed out after 10 minutes
   - Browser automation likely stuck on cookie banner or slow page load
   - Error: "cron: job execution timed out"

2. **11:34 AM UTC** - Cron job succeeded
   - Fetched 9 predictions from OddsPortal
   - Successfully sent to Tech News channel (-1003369440176)
   - Message ID: 35
   - Duration: ~2.5 minutes

### Loop Incident (13:48-13:50 UTC)
3. **13:48:55** - New webchat session started
4. **13:49:08** - Predictions output #1
5. **13:49:24** - Predictions output #2 (16 sec later)
6. **13:49:50** - Predictions output #3 (26 sec later)
7. **13:50:07** - Predictions output #4 (17 sec later)
8. **13:50:23** - Predictions output #5 (16 sec later)

**Total loop duration:** ~1.5 minutes
**Pattern:** Every 15-26 seconds

## Technical Analysis

### Message Properties
All looped messages had:
```json
{
  "api": "openai-responses",
  "provider": "openclaw",
  "model": "delivery-mirror",
  "usage": {
    "input": 0,
    "output": 0,
    "totalTokens": 0,
    "cost": 0
  }
}
```

**Key finding:** Using `delivery-mirror` model, not the actual GLM-5 model. This indicates the issue was in the message delivery layer, not the agent reasoning layer.

### Cron Job Configuration
```json
{
  "sessionTarget": "isolated",
  "wakeMode": "now",
  "delivery": {
    "mode": "announce",
    "channel": "telegram",
    "to": "-1003369440176"  // Tech News channel
  }
}
```

**Issue:** Announcements should only go to Tech News channel, but somehow leaked into the main webchat session.

## Possible Root Causes

1. **Message Routing Bug**
   - Announcement meant for Tech News channel got routed to webchat
   - Possibly due to session ID confusion or binding issue

2. **Delivery Queue Issue**
   - Messages queued for delivery got stuck and repeatedly processed
   - Each processing cycle re-sent the same message

3. **Session State Leak**
   - Isolated cron session state somehow bled into main webchat session
   - Caused repeated message deliveries

4. **Gateway Bug**
   - OpenClaw gateway may have had a message processing loop
   - Repeatedly tried to deliver the same announcement

## Immediate Actions Taken

1. ✅ **Disabled cron job** - Prevented further automated runs
2. ✅ **Investigated logs** - Found the loop pattern in session transcript
3. ✅ **Analyzed routing** - Confirmed delivery-mirror model usage

## Recommended Fixes

### Short-term (Immediate)
1. **Keep cron job disabled** until routing bug is understood
2. **Monitor webchat sessions** for repeated messages
3. **Check OpenClaw gateway logs** for message processing errors

### Medium-term (This Week)
1. **Review OpenClaw delivery system** - Check announce mode implementation
2. **Add message deduplication** - Prevent same content being sent multiple times
3. **Add delivery logging** - Track when/where messages are sent
4. **Test announcement routing** - Verify isolated sessions only announce to target

### Long-term (Next Sprint)
1. **Add timeout handling** - Better handling for browser automation timeouts
2. **Add retry logic** - Smarter retry for failed cron jobs (not immediate retry)
3. **Session isolation audit** - Ensure isolated sessions can't leak into main sessions

## Browser Automation Issues

### First Run Timeout (10:00 AM)
- **Duration:** 10 minutes (600,030 ms)
- **Likely cause:** Browser stuck on cookie banner or slow page load
- **Fix needed:** Add explicit timeout handling for browser actions

### Second Run Success (11:34 AM)
- **Duration:** 2.5 minutes (149,027 ms)
- **Status:** Completed successfully
- **Lesson:** Browser automation is unreliable, need better error handling

## Related Files
- `/root/.openclaw/skills/oddsportal-predictions/SKILL.md` - Skill definition
- `/root/.openclaw/agents/main/sessions/a7c21af8-929b-44c6-8104-85d0b31ed39a.jsonl` - Session transcript
- `/root/.openclaw/openclaw.json` - Gateway configuration
- Cron job ID: `5f053b1f-b613-4fde-9718-46b084058273`

## Next Steps
1. Contact OpenClaw team about delivery-mirror routing bug
2. Add message deduplication to prevent repeated outputs
3. Review isolated session announcement implementation
4. Consider alternative to browser automation (API if available)
