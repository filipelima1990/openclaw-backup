# Memory Log - 2026-02-13

## Git Workflow Implementation for portugal-house-market

**Project:** /opt/portugal-house-market
**GitHub:** https://github.com/filipelima1990/portugal-house-market
**Status:** IN PROGRESS (Step 3 of 16 completed)

### Objective
Implement professional git workflow with separate dev and production environments on the same Hetzner instance, with automated deployments via GitHub Actions.

### Architecture (Target State)
- **Dev:** /opt/portugal-house-market-dev → Prefect on port 4200 → tracks `dev` branch
- **Prod:** /opt/portugal-house-market → Prefect on port 4201 → tracks `main` branch
- **Shared Prefect:** /opt/prefect → Prefect on port 4200 (existing multi-project server)

### Progress

#### Step 1 ✅ - Verify Current State
- Location: /opt/portugal-house-market
- Current branch: main
- Git remote: git@github.com:filipelima1990/portugal-house-market.git (SSH configured)
- Uncommitted changes discarded (deploy_flow.py, src/flows/scrape_flow.py, src/flows/__init__.py, prefect.yaml)

#### Step 2 ✅ - Create Dev Branch on GitHub
- Created `dev` branch from `main`
- Pushed to GitHub
- Both `origin/main` and `origin/dev` exist

#### Step 3 ✅ - Reconfigure Current Prefect as Dev Environment
- **NOTE:** Shared Prefect server exists at /opt/prefect (port 4200)
- Created venv at /opt/portugal-house-market/venv
- Installed Prefect in venv
- Created systemd service: `/etc/systemd/system/prefect-server-dev.service`
- Service config:
  - Port: 4200
  - Working Directory: /opt/portugal-house-market-dev (to be renamed in Step 5)
  - Prefect API URL: http://127.0.0.1:4200/api
  - Status: Created but NOT started

### Next Steps
- Step 4: Create production directory structure
- Step 5: Rename directories for clarity
- Step 6: Set dev directory to track dev branch
- Step 7-16: Continue with service creation, GitHub Actions, testing, documentation

### Important Notes
- Shared Prefect server on port 4200 at /opt/prefect may cause conflict with dev Prefect
- May need to re-evaluate port strategy - perhaps use 4201 for dev and 4202 for prod, or use shared Prefect with different work pools
- Current plan has dev on 4200 and prod on 4201, but shared Prefect already uses 4200

---

## Portugal Geographical Database Research

**Request:** Deep research on Portuguese databases with maximum geographical granularity for 2 junior data engineers
**Research Date:** 2026-02-13
**Document Saved:** PORTUGAL_DATA_RESEARCH.md

### Key Data Sources Identified

**Core Official Sources (Free):**
- **INE (Instituto Nacional de Estatística)** - https://www.ine.pt/
  - Census 2021 data at parish (freguesia) level
  - Economic activity (CAE) by parish
  - Quarterly housing prices
  - Population, demographics, employment data
  - Granularity: National → District → Municipality → Parish → Statistical Sections

- **dados.gov.pt** - https://dados.gov.pt/en/
  - National open data portal
  - 20,100+ datasets, 42,900+ files, 422 organizations
  - Categories: demographics, education, healthcare, infrastructure, environment, economy
  - API: CKAN-based with REST endpoints

- **CAOP (Carta Administrativa Oficial de Portugal)** - DGT
  - Official administrative boundaries
  - Formats: Shapefile, GeoJSON, KML, PostGIS
  - Geographic levels: District, Municipality (concelho), Parish (freguesia)
  - Alternative sources: GeoPostcodes, IGISMap

- **Pordata** - https://www.pordata.pt/en/
  - Socioeconomic indicators database
  - Primarily national level, some regional/municipal data
  - Fundação Francisco Manuel dos Santos project

### Specialized Data Sources

**Real Estate:**
- **Idealista** - https://www.idealista.pt/
  - Portugal's largest real estate platform
  - No official API - requires scraping
  - Commercial scrapers: Apify ($4.99/month + API costs), Scrapfly
  - Open source: GitHub repositories available
  - Data points: prices, property features, coordinates, agency info
  - Granularity: Exact coordinates (can geocode to parish)

**Transportation:**
- **GTFS feeds** - Public transportation
  - Lisbon Metro: Transitland feed
  - Lisbon Open Data: dadosabertos.cm-lisboa.pt
  - GitHub API: transportes-portugal-api
  - Data: Routes, schedules, stops (can geocode to parish)

**Economic Activity:**
- **E-REDES Open Data** - https://e-redes.opendatasoft.com/
  - INE CAE data by district, municipality, parish
  - Fields: Year, geographic codes, CAE code, number of companies
  - Frequency: Annual
  - Coverage: Continental Portugal

**Healthcare:**
- **SNS (National Health Service)** - https://www.sns.gov.pt/
  - Hospital and healthcare facility locations
  - Emergency services data
  - Open data available on dados.gov.pt

**Weather:**
- **IPMA (Instituto Português do Mar e da Atmosfera)** - http://www.ipma.pt/
  - Weather stations across Portugal
  - Historical data and forecasts
  - API available (requires registration)

**Community Data:**
- **OpenStreetMap** - https://www.openstreetmap.org/
  - POIs: restaurants, shops, schools, hospitals, amenities
  - Road networks, building footprints, land use
  - Key tags: amenity, shop, tourism, leisure
  - Access: Overpass API, Geofabrik downloads, OSMPoisPbf

### Data Enrichment Examples

**McDonald's by Council/Parish:**
- Source: OpenStreetMap (`brand=McDonald's` tag)
- Query OSM, spatial join with parish boundaries
- Metrics: Count per parish, density per capita, cluster analysis
- POIdata.io: 103 McDonald's in Portugal (Oct 2025)

**Houses for Sale by Parish:**
- Source: Idealista (scraped)
- Aggregate metrics: Average price/m², number of listings, price distribution
- Advanced: Days on market, price changes, transport proximity correlations

**Restaurant Density by Parish:**
- Source: OpenStreetMap (`amenity=restaurant`, `cafe`, `fast_food`)
- Metrics: Count per parish, density per capita, cuisine diversity, chain vs independent

**School Accessibility:**
- Source: INE school locations + OSM roads
- Metrics: Schools within 1km/2km, student-to-school ratio, network analysis

**Economic Activity Heatmap:**
- Source: E-REDES CAE dataset
- Metrics: Top industry per parish, employment concentration, business diversity index

**Public Transport Coverage:**
- Source: GTFS stops + CAOP
- Metrics: % parish area within 500m of stop, stops/km², service frequency

**Healthcare Accessibility Index:**
- Source: SNS locations + INE population
- Metrics: Hospital beds per 10,000, emergency response coverage, primary care density

**Housing Market Segmentation:**
- Source: Idealista + INE + E-REDES
- Clustering: Price, growth, population density, income, economic activity
- Segments: Premium markets, commuter zones, rural/low-cost, emerging

### Technical Recommendations

**Database Stack:**
- PostgreSQL with PostGIS - Best for geospatial queries
- Python - pandas, geopandas, sqlalchemy
- Apache Airflow or Prefect - Orchestration
- Streamlit or Metabase - Visualization

**Why PostGIS:**
- Native spatial joins (ST_Contains, ST_Intersects)
- Efficient geocoding operations
- Standard SQL interface
- Strong community support

**Data Model - Core Tables:**
- districts (code, name, geometry)
- municipalities (code, district_code, name, geometry)
- parishes (code, municipality_code, name, population, area_km2, geometry)
- pois (osm_id, name, category, subcategory, brand, geometry, parish_code)
- properties (idealista_id, price, area_m2, price_per_m2, property_type, bedrooms, bathrooms, geometry, parish_code, listing_date)

### Implementation Roadmap (10 Weeks)

**Phase 1: Foundation (Week 1-2)**
- Download CAOP shapefiles (parish boundaries)
- Import to PostGIS
- Load INE parish-level population data
- Create geographic hierarchy tables

**Phase 2: Open Data Integration (Week 3-4)**
- Extract E-REDES economic activity data
- Download OSM POI data (Overpass API)
- Load school and healthcare facility data
- Build spatial joins with parishes

**Phase 3: Real Estate (Week 5-6)**
- Set up Idealista scraper (Apify or custom)
- Run initial scrape (target 50,000+ listings)
- Geocode to parish level
- Build price aggregates

**Phase 4: Transportation (Week 7-8)**
- Download GTFS feeds (Lisbon, Porto)
- Import stops to PostGIS
- Calculate coverage metrics
- Build accessibility indices

**Phase 5: Enrichment (Week 9-10)**
- Build composite indices (accessibility, market segments)
- Create data quality checks
- Build dashboards
- Document data lineage

### Cost Estimates

**Free Sources:**
- INE, dados.gov.pt, CAOP, OpenStreetMap, Pordata

**Paid Sources (Optional):**
- Idealista scraping: $5-50/month depending on volume
- Commercial POI databases: $100-500/month
- Company registry access: Varies

### Recommended First Project for Juniors

**McDonald's Mapping:**
- Extract McDonald's from OSM (Overpass API query)
- Count per parish using spatial join
- Calculate density per capita using INE population data
- Visualize on map (Folium or Streamlit)
- Clear deliverables, demonstrates spatial joins

### Key Insights from Social Media Research

**Reddit (r/opendata_pt, r/portugal, r/PortugalExpats):**
- INE is widely respected as authoritative source
- DGT preferred for geographic data
- OpenStreetMap well-maintained for Portugal
- Real estate data requires scraping (no official API)
- Some INE data only available as PDF/Excel exports
- Pordata has no public API
- INE APIs have limited documentation

### Key Reference Links

**Official Portuguese Data:**
- INE: https://www.ine.pt/
- dados.gov.pt: https://dados.gov.pt/en/
- CAOP: https://www2.gov.pt/en/servicos/consultar-a-carta-administrativa-oficial-de-portugal-caop-
- DGT: https://www.dgterritorio.gov.pt/
- SNS: https://www.sns.gov.pt/
- IPMA: http://www.ipma.pt/

**Community Data:**
- OpenStreetMap: https://www.openstreetmap.org/
- Overpass API: https://overpass-api.de/
- Pordata: https://www.pordata.pt/en/

**Tools & APIs:**
- Geofabrik OSM extracts: http://download.geofabrik.de/
- OSMPoisPbf: https://wiki.openstreetmap.org/wiki/OsmPoisPbf
- Transportes Portugal API: https://github.com/AndreVarandas/transportes-portugal-api

**Scraping Tools:**
- Apify Idealista Scraper: https://apify.com/igolaizola/idealista-scraper/api/openapi
- Scrapfly Guide: https://scrapfly.io/blog/posts/how-to-scrape-idealista
- GitHub scrapers: https://github.com/FlowExtractAPI/idealista-scraper-api

**Geographic Data:**
- GeoPostcodes: https://www.geopostcodes.com/country/portugal/shapefile/
- IGISMap: https://www.igismap.com/download-portugal-administrative-boundary-gis-data/

### Conclusion

Portugal has excellent data infrastructure for building a comprehensive geographical database. Starting with INE, dados.gov.pt, and CAOP provides a solid foundation at parish-level granularity. Enriching with OpenStreetMap POIs and real estate data provides business insights.

Key advantage: Most core data is **free and official** from government sources, making this ideal for junior data engineers to learn data engineering concepts while building something valuable.

### Next Steps

1. Set up PostgreSQL with PostGIS
2. Download CAOP 2024 boundaries (parish level)
3. Load INE population data (latest census 2021)
4. Create geographic hierarchy (District → Municipality → Parish)
5. Start with McDonald's mapping project as proof-of-concept
