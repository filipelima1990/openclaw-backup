# 2026-02-11

## Prefect Worker Setup

**Issue:** Scheduled flow runs were marked as "Late" because the worker process wasn't running to execute them.

**Root Cause:** The deployment "daily-scrape-housing-nationwide" was set up but no worker was running to pick up scheduled runs from the `default-pool` work pool.

**Fix Applied:**

1. **Created systemd service for Prefect worker:**
   - Location: `/etc/systemd/system/prefect-worker.service`
   - Auto-starts on boot
   - Restarts automatically on failure
   - Listens to `default-pool` work pool

2. **Service details:**
   ```ini
   [Unit]
   Description=Prefect Worker
   After=network.target prefect.service

   [Service]
   Type=simple
   User=root
   WorkingDirectory=/opt/prefect
   Environment="PATH=/opt/prefect/venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
   Environment="PREFECT_API_URL=http://localhost:4200/api"
   ExecStart=/opt/prefect/venv/bin/prefect worker start --pool default-pool
   Restart=on-failure
   RestartSec=5s

   [Install]
   WantedBy=multi-user.target
   ```

3. **Updated documentation:**
   - Updated `/opt/prefect/README.md` with worker service info
   - Updated `/opt/prefect/manage.sh` with worker commands:
     - `worker-start` - Start worker
     - `worker-stop` - Stop worker
     - `worker-restart` - Restart worker
     - `logs-worker` - View worker logs
     - `status` - Shows both server and worker status

**Cleanup:** Initially deleted deployment "Daily Scrape and Load Housing Data/daily-scrape-housing-nationwide" thinking the project was wiped, but the directory still exists.

**Flow Crash Investigation:**
- The crashed run "lively-octopus" was scheduled for 1 AM UTC
- When worker started at 10:57 UTC, it picked up this late run
- Error: `ModuleNotFoundError: No module named 'polars'`
- Root cause: Prefect worker venv (`/opt/prefect/venv`) didn't have project dependencies
- Project venv (`/root/.openclaw/workspace/portugal-house-market/venv`) had all dependencies but worker wasn't using it

**Fix Applied:**
1. Installed project dependencies into Prefect venv:
   - polars==0.20.3
   - httpx==0.26.0
   - beautifulsoup4==4.12.2
   - lxml==5.1.0
   - rich==13.7.0
   - python-dotenv==1.0.0
   - psycopg2-binary==2.9.9
   - pyarrow>=14.0.0,<15.0.0
2. Redeployed the housing scraping flow
3. Manually triggered test run - now executing successfully

**Status:**
- âœ… Worker running and processing flow runs
- âœ… Daily scrape flow deployed and tested successfully
- âœ… All dependencies installed in Prefect venv
- âœ… Scheduled runs will execute automatically at 1 AM UTC

---

## Streamlit Dashboard Debugging (Afternoon)

**Context:** Filipe noticed the gambling dashboard Streamlit app was failing and asked to debug together.

### Issues Found & Fixed

**Critical Issues:**
1. **`st.confirm()` doesn't exist** - Streamlit has no `confirm()` dialog. Replaced with two-step button pattern using `st.session_state` for dangerous actions (clear all data).
2. **"This Week" filter incorrect** - Was showing "last 7 days" instead of calendar week. Fixed to calculate from Monday to current day using `pd.Timestamp.now().weekday()`.
3. **Missing 'profit' column** - Transactions page tried to display `df[['date_formatted', 'formatted', 'amount', 'profit']]` but profit wasn't calculated. Added `calculate_profit()` function:
   - Wins: `amount * (odds - 1)`
   - Losses: `-amount`
   - Voids: `0`
   - Deposits/Withdrawals: `0`
4. **Undefined variables** - When `bets_df.empty`, variables like `total_bets`, `win_rate`, etc. were never defined. Initialized all with default values before conditional block.

**Improvements:**
- Moved imports (`get_break_even_win_rate`, `find_best_worst_days`) to top of file
- Removed unused imports (`json`, `time_utils`, `exporter`)
- Added `.get()` with defaults for dictionary access (safe against KeyError)
- Added try-catch for chart generation and best/worst days
- Changed goals access to use `.get()` instead of direct indexing
- Removed redundant `load_goals()` calls that could overwrite unsaved changes
- Fixed stats preview to show period-specific values instead of all-time
- Changed success messages to `st.toast()` (visible even after rerun)
- Added safety checks for NaN odds values
- Added safety for `best_streak["count"]` using `.get("count", 0)`

**User Requested:**
- Removed Export page entirely (not needed)

**File Changes:**
- `/opt/gambling-bot/app.py` - Fixed all bugs and removed Export section
- Navigation sidebar updated to remove "ðŸ“„ Export" option

**Testing:**
- App starts successfully on port 8501
- Health check returns `ok`
- Ready for user testing

---

## Gambling Bot & Dashboard Updates (Evening)

**User Requests:**
1. Remove bet target - only keep profit target
2. Add transaction recording in Streamlit app (not just Telegram)
3. Add market field to bets (ML, Over/Under Goals, Handicap)

**Implementation - Hybrid Market Approach:**

**Telegram Commands:**
```
/bet 10 win 2.0 ml      â† Money Line
/bet 10 win 2.0 o2.5    â† Over 2.5 Goals
/bet 10 win 2.0 u2.5    â† Under 2.5 Goals
/bet 10 win 2.0 h+1     â† Handicap +1
/bet 10 win 2.0 h-0.5   â† Handicap -0.5
```

**Streamlit App:**
- Added "ðŸ“ Add Transaction" page with:
  - Deposit form (amount input)
  - Withdrawal form (amount input)
  - Bet form with:
    - Amount, result, odds
    - Market dropdown: Money Line, Over Goals, Under Goals, Handicap
    - For Over/Under: select goals value (0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5, 4.0, 4.5, 5.0)
    - For Handicap: select sign (+/-) and value (e.g., +1, -0.5, +2.5)
    - Live preview of market code
- Market displayed in transactions as `[ML]`, `[O2.5]`, etc.

**Code Changes:**
- `/opt/gambling-bot/bot.py`:
  - Added `market` parameter to `add_transaction()`
  - Updated `/bet` command to parse odds and market intelligently
  - Removed bet target from `/goal`, `/progress`, `/summary` commands
  - Updated help text with market codes
- `/opt/gambling-bot/app.py`:
  - Added "ðŸ“ Add Transaction" page to navigation
  - Removed bet target from Dashboard and Settings
  - Added market display in transactions list
  - Added imports for `update_streak` and `update_odds_ranges`

**Navigation:**
`["ðŸ“Š Dashboard", "ðŸ“ Add Transaction", "ðŸ“‹ Transactions", "âš™ï¸ Settings"]`

**Status:**
- âœ… Bot restarted successfully
- âœ… Streamlit app running on port 8501
- âœ… All Python files compile without errors
- âœ… Market codes implemented in hybrid format

---

## Removed Void, Kept Only Push (Evening)

**User Decision:** Remove "void" result type, keep only "push" for tied bets.

**Changes Made:**
- **Telegram:** Removed "void" from valid results (now: win, loss, push)
- **Streamlit:** Updated bet form dropdown (now: win, loss, push)
- **Messages:** Updated success messages and transaction formatting
- **Help text:** Removed all references to void, updated examples

**Difference:**
- **Push** = Tie/draw (legitimate outcome, profit = 0)
- Refunds should be recorded as withdrawals manually

**Status:**
- âœ… Bot restarted
- âœ… Streamlit app restarted on port 8501
- âœ… All files compile successfully

---

## Market Analysis Added (Evening)

**User Request:** Update `/stats` to reflect market type in statistics

**Implementation:**
- Added market tracking to stats module (`stats.py`):
  - `get_market_type()` - Categorize market codes (ML, Over, Under, Handicap, Other)
  - `update_markets()` - Track stats by market type (similar to odds_ranges)
  - `calculate_market_stats()` - Generate market breakdown
- Updated `bot.py`:
  - Import `update_markets` and `calculate_market_stats`
  - Call `update_markets()` when recording bets
  - Added `format_market_stats()` to display market analysis
  - `/stats` now shows market breakdown for all-time stats
- Updated `app.py`:
  - Added "ðŸ“ Add Transaction" page with deposit, withdrawal, bet forms
  - Bet form includes market dropdown with live preview of market code
  - Market displayed in transactions as `[ML]`, `[O2.5]`, etc.
  - Navigation: Dashboard, Add Transaction, Transactions, Settings

**Status:**
- âœ… Bot restarted successfully
- âœ… Streamlit app running on port 8501
- âœ… All Python files compile without errors
- âœ… Market codes implemented in hybrid format

---

## Removed Void, Kept Only Push (Evening)

**User Decision:** Remove "void" result type, keep only "push" for tied bets.

**Changes Made:**
- **Telegram:** Removed "void" from valid results (now: win, loss, push)
- **Streamlit:** Updated bet form dropdown (now: win, loss, push)
- **Messages:** Updated success messages and transaction formatting
- **Help text:** Removed all references to void, updated examples

**Difference:**
- **Push** = Tie/draw (legitimate outcome, profit = 0)
- Refunds should be recorded as withdrawals manually

**Status:**
- âœ… Bot restarted
- âœ… Streamlit app restarted on port 8501
- âœ… All files compile successfully

---

## Advanced Analytics Features Added (Evening)

**User Request:** Implement all suggested improvements (streak by market, day of week, marketÃ—odds heatmap, market EV, confidence intervals)

**Implementation:**

### 1. Streak by Market
- Track win/loss streaks separately for each market type
- `update_market_streaks()` function tracks streaks per market
- `/stats` shows current streak for each market type

### 2. Day of Week Analysis
- `calculate_day_of_week_stats()` function aggregates performance by day
- Shows profit, total bets, and win rate for each day
- Helps identify which days you perform best

### 3. Market Ã— Odds Heatmap
- `update_market_odds_matrix()` tracks 2D matrix: market Ã— odds range
- Displayed as formatted table in `/stats`
- Shows profit for each market at each odds range

### 4. Market Expected Value (EV)
- `calculate_market_ev()` calculates EV per market (â‚¬/bet)
- Sorted by highest EV to identify most profitable markets
- Helps focus on best-performing markets

### 5. Confidence Intervals
- `calculate_confidence_interval()` uses Wilson score interval
- Shows 95% confidence bounds for win rates
- Example: `58% WR [45%-70%]` means true win rate is likely in that range

**Code Changes:**
- `stats.py`: Added all new functions
- `bot.py`: Added formatting functions and updated `/stats` command
- `app.py`: Added new dashboard sections for all analytics

**Status:**
- âœ… Bot restarted successfully
- âœ… Streamlit app restarted on port 8501
- âœ… All files compile successfully

---

## Categorized Markets in Betting Dropdown (Evening)

**User Question:** Once I categorize a specific market, will it be shown correctly in the dropdown menu?

**Answer:** YES! Categorized markets now appear in the betting dropdown.

**Implementation:**
- Dropdown now shows ALL markets: 4 core + all categorized ones
- Categorized markets detected automatically from `state["market_categories"]`
- When a categorized market is selected:
  - Shows `ðŸ“ Categorized Market: [bttsy]` hint
  - Uses the market code directly (e.g., `bttsy`)
  - Stats are tracked properly (streaks, EV, confidence intervals)

**Workflow:**
1. Go to Market Management page
2. Create category "Outcome Markets"
3. Assign `bttsy` to "Outcome Markets"
4. Go to Add Transaction â†’ dropdown now shows "bttsy"!
5. Place bet with categorized market
6. Stats show breakdown by your categories

**Status:**
- âœ… Bot restarted successfully
- âœ… Streamlit app running on port 8501
- âœ… Categorized markets now appear in betting dropdown

---

## Custom Market Management System (Evening)

**User Proposal:**
- Keep original 4 markets in betting flow (fast)
- Add "Custom" option for any market code (flexible)
- Create Market Management page to categorize markets (organized later)
- Stats show by category instead of individual markets

**Implementation:**

### 1. Simplified Market Dropdown
- Streamlit: Money Line, Over Goals, Under Goals, Handicap, **Custom**
- Custom: Free text input for any code (bttsy, acc4, c8.5, dnb, etc.)
- Shows live preview of market code

### 2. Market Management Page (ðŸ·ï¸)
- **Uncategorized Markets:** Shows all custom markets not yet assigned
- **Categories:** Create named categories (Outcomes, Accumulators, Props, etc.)
- **Assign Markets:** Drag markets into categories (organized for stats)
- **Delete Categories:** Remove unused categories
- State structure: `state["market_categories"] = {"Outcomes": [...], "Accumulators": [...]}`

### 3. State Structure Update
- Added `market_categories` to state.json
- Pre-populated with example categories:
  - Outcomes: 12, 1x, x2, bttsy, bttsn, dnb
  - Accumulators: double, treble, acc4, acc5, acc6
  - Goals Stats: c8.5, c9.5, c10.5, card3.5, card4.5
  - Time Markets: hth, htd, hta, dhh, ddd, dda, ahh, add, aaa
  - Goalscorers: fgsh, fgsa, fgsl, fgsn, lgsh, lgsa, lgsl, lgsn
  - Result Markets: r3, r5, r7, r9

### 4. Stats Module
- Market codes are now treated as "Other" in stats (categorized later)
- Existing analytics work with custom markets (streaks, EV, confidence intervals)

**Workflow:**
1. Place bet with custom code: `/bet 10 win 2.0 bttsy`
2. Go to Market Management page
3. Create category "Outcome Markets"
4. Assign `bttsy` to "Outcome Markets" category
5. Stats can later show "Outcome Markets: +â‚¬25.00 (8 bets, 62% WR)"

**Benefits:**
- Fast betting (no scrolling 18+ options)
- Flexible (any code works)
- Organized (categorize later at your pace)
- Stats ready for category breakdown

**Status:**
- âœ… Bot restarted
- âœ… Streamlit running on port 8501
- âœ… All files compile successfully

---

## Extended Market Types Added (Evening)

**User Request:** Add more market types: double, treble, acca, corners, R3/R7/R9, etc.

**New Markets Added:**
- **Double Chance:** 12, 1X, X2 (covers 2 outcomes)
- **Both Teams Score (BTTS):** bttsy, bttsn
- **Draw No Bet (DNB):** dnb
- **Accumulators:** double, treble, acc4, acc5, etc.
- **Corners:** c8.5, c9.5, c10.5 (o=over, u=under)
- **Cards:** card3.5, card4.5
- **HT/FT:** hth, htd, hta, dhh, ddd, dda, ahh, add, aaa
- **First/Last Goalscorer:** fgsh, fgsa, fgsl, fgsn, lgsh, lgsa, lgsl, lgsn
- **Result at X Goals:** r3, r5, r7, r9

**Implementation:**
- Updated `get_market_type()` in stats.py to categorize all new markets
- Updated Streamlit app dropdown with all 18 market types
- Added appropriate value inputs for each market type
- Updated market code generation logic
- Updated bot help text with all market examples

**Market Codes Summary:**
- Money Line: ml
- Goals: o2.5, u2.5
- Handicap: h+1, h-0.5
- Double Chance: 12, 1x, x2
- BTTS: bttsy, bttsn
- DNB: dnb
- Accumulators: double, treble, acc4, etc.
- Corners: c8.5, c9.5
- Cards: card3.5, card4.5
- HT/FT: hth, htd, etc.
- Goalscorer: fgsh, fgsa, etc.
- Result: r3, r5, r7, r9

**Status:**
- âœ… Bot restarted successfully
- âœ… Streamlit app running on port 8501
- âœ… All files compile successfully

---

## Market Analysis Added (Evening)

**User Request:** Update `/stats` to reflect market type in statistics

**Implementation:**
- Added market tracking to stats module (`stats.py`):
  - `get_market_type()` - Categorize market codes (ML, Over, Under, Handicap, Other)
  - `update_markets()` - Track stats by market type (similar to odds_ranges)
  - `calculate_market_stats()` - Generate market breakdown
- Updated `bot.py`:
  - Import `update_markets` and `calculate_market_stats`
  - Call `update_markets()` when recording bets
  - Added `format_market_stats()` to display market analysis
  - `/stats` now shows market breakdown for all-time stats
- Updated `app.py`:
  - Import market functions
  - Call `update_markets()` in Add Transaction page
  - Dashboard shows "Performance by Market Type" (All Time only)
  - Displays: profit, total bets, win rate per market

**Market Stats Display:**
```
ðŸ“Š Performance by Market Type:
  ðŸŸ¢ Over Goals: â‚¬45.00 (12 bets, 58% WR)
  ðŸ”´ Handicap: -â‚¬15.00 (8 bets, 37% WR)
  ðŸŸ¢ Money Line: â‚¬30.00 (5 bets, 60% WR)
```

**Suggested Improvements:**
1. **Streak by market** - Track win/loss streaks for each market type separately
2. **Day of week analysis** - See which days you perform best on each market
3. **Market x Odds heatmap** - 2D matrix showing profit by market AND odds range
4. **Best market by EV** - Calculate expected value per market to identify which are most profitable
5. **Confidence intervals** - Show statistical significance of win rate (is 58% on Over Goals really better than 50%?)

Which ones interest you?

---

## Removed Charts & Heatmap from /stats (Evening)

**User Request:** Remove odds heat map and charts from /stats command (Telegram only)

**Changes Made:**
- Removed `format_market_odds_matrix()` function (no longer needed)
- Removed call to `format_market_odds_matrix()` from /stats command
- Removed chart generation section from /stats command
- Market Ã— Odds heatmap no longer displayed in Telegram /stats

**What Remains in /stats:**
- Market performance (profit, bets, WR, confidence intervals)
- Market streaks (current win/loss streak per market)
- Market EV (expected value per market)
- Day of week analysis (performance by day)
- Best/worst days
- Odds ranges (profit by odds range)
- Goals and stop loss status

**Note:** Charts are still available in Streamlit Dashboard (visual analytics)

**Status:**
- âœ… Bot restarted
- âœ… Streamlit running
- âœ… All files compile successfully
