# 2026-02-14

## PostgreSQL Database Separation (Dev/Prod)

**Context:** Requested by Filipe to create separate PostgreSQL databases for dev and prod environments instead of sharing them across both environments.

### Databases Created

Created separate databases for each project's dev and prod environments:

| Environment | Football Data | Housing Market |
|-------------|---------------|----------------|
| **Dev** | `football_data_dev` | `portugal_houses_dev` |
| **Prod** | `football_data_prod` | `portugal_houses_prod` |

### Infrastructure

- **PostgreSQL container:** `postgres` (port 5432)
- **User:** `postgres` (password: `prefect123`)
- **Additional user:** `dataeng` (password: `changeme`) - For housing project
- **Prefect backend:** Still uses `postgres` database (unchanged)

### Project Configurations Updated

**Football Data:**
- `/opt/football-data/.env` → `DB_NAME=football_data_prod`
- `/opt/football-data-dev/.env` → `DB_NAME=football_data_dev`

**Housing Market:**
- `/opt/portugal-house-market/.env` → `POSTGRES_DB=portugal_houses_prod`
- `/opt/portugal-house-market-dev/.env` → `POSTGRES_DB=portugal_houses_dev`

### Schemas Created

**Football Data (both dev and prod):**
- Table: `raw_pl_matches` (public schema)
- Indexes: match_date, home_team, away_team, league_division

**Housing Market (both dev and prod):**
- Schema: `raw` - Raw scraped data (listings table, listings_latest view)
- Schema: `staging` - Intermediate transformations (price_history table)
- Schema: `marts` - Final analytics tables (ready for dbt)

### Architecture Decision

**Strategy:** Separate databases for each project × environment combination

Benefits:
- Clean separation between dev and prod
- Prevents accidental cross-contamination
- Easier to reset dev environment without affecting prod
- Clear ownership of data

**Previous setup (deprecated):**
- `football_data` - Old shared database (still exists but unused)
  - Can be migrated to `football_data_prod` if needed
  - Should be dropped after migration is confirmed

### Documentation Created

1. `/opt/football-data/DEPLOYMENT.md` - Updated with database configuration section
2. `/opt/portugal-house-market/DEPLOYMENT.md` - Created with full deployment guide including database setup
3. `/root/.openclaw/workspace/DATABASE_SETUP.md` - Complete setup summary and reference guide
4. `/root/.openclaw/workspace/create_schemas.py` - Script to recreate schemas if needed

### Verification Commands

```bash
# List all databases
docker exec postgres psql -U postgres -c "\l"

# Check football data schema
docker exec postgres psql -U postgres -d football_data_prod -c "\dt"

# Check housing schema
docker exec postgres psql -U postgres -d portugal_houses_prod -c "\dt raw.*"
```

### Integration with Existing Workflow

Both projects continue to use the **shared Prefect server** at `/opt/prefect` (port 4200):
- **Football Data:** `weekly-load-premier-league` deployment (Sundays 10:00 AM UTC)
- **Housing Market:** `daily-scrape-porto-housing` deployment (Daily 9:00 AM UTC)

Flows automatically read the correct database from `.env` files based on which directory they run from (dev or prod).

### Next Steps

1. **Test deployments:** Verify that both dev and prod deployments work correctly
2. **Backup old data:** If needed, migrate data from old `football_data` to `football_data_prod`
3. **Drop old database:** After confirming migration works, drop deprecated `football_data` database
4. **Set up backups:** Configure automated backups for production databases
5. **Monitor usage:** Check database connection patterns and query performance

---

**Status:** ✅ Database separation completed successfully

## Model Configuration Change

**Context:** User requested to switch from GLM-4.7 to GLM 5.

### Change Made

- **Previous model:** `zai/glm-4.7` (alias: GLM)
- **New model:** `zai/glm-5` (alias: GLM)
- **Method:** Updated `agents.defaults.model.primary` via `gateway config.patch`
- **Gateway restart:** Applied via SIGUSR1 (delay 2000ms)

### Configuration Files

Updated `/root/.openclaw/openclaw.json`:
```json
{
  "agents": {
    "defaults": {
      "model": {
        "primary": "zai/glm-5"
      },
      "models": {
        "zai/glm-4.7": { "alias": "GLM" },
        "zai/glm-5": { "alias": "GLM" }
      }
    }
  }
}
```

**Status:** ✅ Model switch completed successfully, gateway reloaded
